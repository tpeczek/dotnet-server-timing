<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Advanced | Server Timing API support for .NET </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Advanced | Server Timing API support for .NET ">
    <meta name="generator" content="docfx 2.59.4.0">
    
    <link rel="shortcut icon" href="../resources/ico/favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../resources/svg/logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-12">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="advanced">Advanced</h1>

<p>This section covers following subjects:</p>
<ul>
<li><a href="#timing-blocks-of-code">Timing Blocks of Code</a></li>
<li><a href="#timing-tasks">Timing Tasks</a></li>
<li><a href="#metric-filters-aspnet-core-only">Metric Filters (ASP.NET Core Only)</a></li>
</ul>
<h2 id="timing-blocks-of-code">Timing Blocks of Code</h2>
<p><a href="../api/Lib.ServerTiming.ServerTimingExtensions.html"><code>ServerTimingExtensions</code></a> provide <code>TimeAction</code> method which allows for timing block of code. Calling the method starts a timer which will be stopped upon disposing the returned value.</p>
<pre><code class="lang-cs">...

IDisposable serverTimerInstance = _serverTiming.TimeAction();

for (int daysFromToday = 1; daysFromToday &lt;= 10; daysFromToday++)
{
    weatherForecasts.Add(await GetWeatherForecastAsync(daysFromToday));
};

serverTimerInstance.Dispose();

...
</code></pre><p>This also allows for wrapping code block in <code>using</code> statement.</p>
<pre><code class="lang-cs">...

using (_serverTiming.TimeAction())
{
    for (int daysFromToday = 1; daysFromToday &lt;= 10; daysFromToday++)
    {
        weatherForecasts.Add(await GetWeatherForecastAsync(daysFromToday));
    };
}

...
</code></pre><p>Above snippets doesn&#39;t provide name for the metric as it is an optional parameter. If not provided, the method will generate a metric name based on caller attributes.</p>
<center><img src="../resources/timing-blocks-of-code.png" alt="Timing Blocks of Code"></center>

<p>It&#39;s possible to nest timed code blocks, in such case it&#39;s strongly advised to provide names for metrics.</p>
<pre><code class="lang-cs">...

using (_serverTiming.TimeAction(&quot;getting-weather-forecasts&quot;))
{
    for (int daysFromToday = 1; daysFromToday &lt;= 10; daysFromToday++)
    {
        using (_serverTiming.TimeAction($&quot;getting-weather-forecast-{daysFromToday}&quot;))
        {
            weatherForecasts.Add(await GetWeatherForecastAsync(daysFromToday));
        }
    };
}

...
</code></pre><p>Unfortunatelly, the Server Timing API doesn&#39;t have a concept of nested metrics and there is no convention for nested rendering in browsers.</p>
<center><img src="../resources/timing-nested-blocks-of-code.png" alt="Timing Nested Blocks of Code"></center>

<h2 id="timing-tasks">Timing Tasks</h2>
<p><a href="../api/Lib.ServerTiming.ServerTimingExtensions.html"><code>ServerTimingExtensions</code></a> also provides <code>TimeTask</code> method which allows for timing a <code>Task</code>.</p>
<pre><code class="lang-cs">...

using (_serverTiming.TimeAction(&quot;getting-weather-forecasts&quot;))
{
    for (int daysFromToday = 1; daysFromToday &lt;= 10; daysFromToday++)
    {
        weatherForecasts.Add(await _serverTiming.TimeTask(GetWeatherForecastAsync(daysFromToday), $&quot;getting-weather-forecast-{daysFromToday}&quot;));
    };
}

...
</code></pre><p>The result of the above snippet is exactly the same as the previous one.</p>
<h2 id="metric-filters-aspnet-core-only">Metric Filters (ASP.NET Core Only)</h2>
<p>Filters, available for ASP.NET Core implementation, provide a way to inspect and modify the metrics which are to be delivered in a response to current request. They run on the collected metrics just before they are set as the response header value. This provides flexibility around exposing metrics only in certain scenarios or to certain clients.</p>
<p>Filters can be added when registering the middleware by interacting with the <code>Filters</code> collection available on <a href="../api/Lib.AspNetCore.ServerTiming.ServerTimingOptions.html"><code>ServerTimingOptions</code></a>.</p>
<pre><code class="lang-cs">public class Startup
{
    public void Configure(IApplicationBuilder app)
    {
        ...

        app.UseServerTiming(new ServerTimingOptions
        {
            Filters = new List&lt;IServerTimingMetricFilter&gt; { ... }
        });

        ...
    }
}
</code></pre><p>There is a number of builti-in filters:</p>
<ul>
<li><a href="../api/Lib.AspNetCore.ServerTiming.Filters.RestrictToDevelopmentMetricFilter.html"><code>RestrictToDevelopmentMetricFilter</code></a> (removes all metrics unless an application is running in development environment)</li>
<li><a href="../api/Lib.AspNetCore.ServerTiming.Filters.RestrictDescriptionsToDevelopmentMetricFilter.html"><code>RestrictDescriptionsToDevelopmentMetricFilter</code></a> (removes the descriptions from all metrics unless an application is running in development environment)</li>
<li><a href="../api/Lib.AspNetCore.ServerTiming.Filters.IPRangeMetricFilter.html"><code>IPRangeMetricFilter</code></a> (removes all metrics unless the current request IP address falls within the specified range)</li>
</ul>
<p>The <a href="../api/Lib.AspNetCore.ServerTiming.ServerTimingOptionsExtensions.html"><code>ServerTimingOptionsExtensions</code></a> class provides some helper methods for adding those built-in filters to an instance of <a href="../api/Lib.AspNetCore.ServerTiming.ServerTimingOptions.html"><code>ServerTimingOptions</code></a>.</p>
<pre><code class="lang-cs">public class Startup
{
    public void Configure(IApplicationBuilder app)
    {
        ...

        ServerTimingOptions options = new ServerTimingOptions();
        options.RestrictMetricsToDevelopment();

        app.UseServerTiming(options);

        ...
    }
}
</code></pre><p>Additionally, there is a <a href="../api/Lib.AspNetCore.ServerTiming.Filters.CustomServerTimingMetricFilter.html"><code>CustomServerTimingMetricFilter</code></a> available (with a dedicated extension method as well) which can take a function to be used for inspecting and modifying the collection of metrics for current request.</p>
</article>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            Copyright © 2017 - 2023 Tomasz Pęczek
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
